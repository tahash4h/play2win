<!DOCTYPE html>
<html>
<head>
<title>Conclusion Based on Findings</title>
<style>
  body {
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
  }
  .container {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px 40px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 80%;
    max-width: 800px;
    text-align: center;
    margin-top: 50px;
  }
  h1 {
    color: #333;
    margin-bottom: 30px;
  }
  .text-block {
    border: 1px solid #ccc;
    padding: 15px;
    margin-bottom: 20px;
    text-align: left;
    min-height: 200px; /* Placeholder for content */
    line-height: 1.6;
    color: #555;
    background-color: #f9f9f9;
    border-radius: 5px;
  }
  .button-container {
    display: flex;
    justify-content: space-between;
    width: 100%;
    margin-top: 30px;
  }
  .button {
    background-color: #007bff;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    text-decoration: none; /* For link-like behavior */
  }
  .button.secondary {
    background-color: #6c757d;
  }
  .loading {
    text-align: center;
    color: #666;
    font-style: italic;
  }
  .error {
    text-align: center;
    color: #e74c3c;
    font-weight: bold;
  }
</style>
</head>
<body>

  <div class="container">
    <h1>Final Play Assessment</h1>
    <div class="text-block" id="conclusionContent">
      <div class="loading">Generating final conclusion...</div>
    </div>
    <div class="button-container">
      <button id="logoutBtn" class="button secondary">Logout</button>
      <a href="/app/information.html" class="button">New Prediction</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      const conclusionContent = document.getElementById('conclusionContent');
      // Read the stored AI outputs from previous pages
      const researcherText = sessionStorage.getItem('researcherFinal') || sessionStorage.getItem('researcherResponse');
      const modelText = sessionStorage.getItem('modelFinal') || sessionStorage.getItem('modelResponse');

      if (!researcherText && !modelText) {
        conclusionContent.innerHTML = '<p class="error">No AI outputs found. Please run the researcher and model predictions first.</p>';
        return;
      }

      try {
  const API_BASE = 'https://play2win-bs0z.onrender.com';
  const response = await fetch(`${API_BASE}/api/conclusions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ researcher: researcherText, model: modelText })
        });

        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (e) {
            errorData = { error: 'Unknown error', details: `HTTP ${response.status}: ${response.statusText}` };
          }

          const errorMsg = errorData.error || 'Failed to generate conclusion';
          const errorDetails = errorData.details || errorData.message || '';
          const fullError = errorDetails ? `${errorMsg}\n\n${errorDetails}` : errorMsg;

          throw new Error(fullError);
        }

        const data = await response.json();

        if (!data.response) {
          throw new Error('No response received from server. The API returned an empty response.');
        }

        // Convert markdown-style formatting to HTML
        let formattedResponse = data.response
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\n\n+/g, '</p><p>')
          .replace(/\n/g, '<br>');

        if (!formattedResponse.startsWith('<p>')) {
          formattedResponse = '<p>' + formattedResponse + '</p>';
        }

        conclusionContent.innerHTML = formattedResponse;

  // Optionally clear the stored finals so repeated visits don't re-run
  try { sessionStorage.removeItem('researcherFinal'); } catch (e) {}
  try { sessionStorage.removeItem('modelFinal'); } catch (e) {}
      } catch (error) {
        console.error('Error generating conclusion:', error);
        const errorMessage = error.message || 'An unknown error occurred';
        conclusionContent.innerHTML = `<p class="error">Error generating conclusion:\n\n${errorMessage}</p>`;
      }
    });

    // Wire logout button
    document.getElementById('logoutBtn').addEventListener('click', function() {
      // Redirect to server logout route which destroys the session
      window.location.href = '/logout';
    });
  </script>
</body>
</html>